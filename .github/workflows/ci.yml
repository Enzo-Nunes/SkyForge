name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [dev]

jobs:
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.14"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      
      - name: Check formatting with Ruff
        run: ruff format --check . --exclude venv
      
      - name: Lint with Ruff
        run: ruff check . --exclude venv

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [db-api, calculator, scraper, web]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ${{ matrix.service }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.service }}/Dockerfile
          push: false
          tags: skyforge-${{ matrix.service }}:latest

  test-compose:
    name: Test Docker Compose Stack
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Start services
        run: docker compose up -d --build
      
      - name: Wait for services to be healthy
        run: |
          for i in {1..30}; do
            if docker compose exec -T db pg_isready -U skyforge > /dev/null 2>&1; then
              echo "Database ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Database failed to start"
              docker compose logs
              exit 1
            fi
            sleep 1
          done
      
      - name: Check web service
        run: |
          curl -f http://localhost:8000 || true
      
      - name: Check db-api health
        run: |
          curl -f http://localhost:5000/health || true
      
      - name: View logs
        if: failure()
        run: docker compose logs
      
      - name: Cleanup
        if: always()
        run: docker compose down -v

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [lint-python, build-docker, test-compose]
    if: always()
    steps:
      - name: Check status
        run: |
          if [[ "${{ needs.lint-python.result }}" == "failure" || 
                "${{ needs.build-docker.result }}" == "failure" ||
                "${{ needs.test-compose.result }}" == "failure" ]]; then
            echo "❌ CI pipeline failed"
            exit 1
          else
            echo "✅ CI pipeline passed"
          fi
